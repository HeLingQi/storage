(function(a){a.TeCmt={options:{action:null,commentAjaxPost:1,commentAjaxLoad:1,commentAjaxLoadElement:"#comment-ajax-list",respondId:null},text:null,tool:null,cmd:null,commentLoading:false,init:function(b){$.extend(TeCmt.options,b);TeCmt.commentLoading=false;$(document).on("focus","#textarea",function(){TeCmt.getTool().slideDown()});$(document).on("click","#textarea",function(){TeCmt.getTool().find(".smiliesbox").slideUp()});$(document).on("click","#te-cmt-cmd a",function(){TeCmt.cmd=$(this).data("cmd");TeCmt.parseCmd();return false});$(document).on("click","#te-cmt-tool .smiliesbox > span",function(){var c=$(this).data("tag");TeCmt.write(c);return false});$(window).scroll(function(){TeCmt.windowScroll()});if(TeCmt.options.commentAjaxPost){TeCmt.initComment()}},getText:function(){return $("#textarea")},getTool:function(){return $("#te-cmt-tool")},initComment:function(){var b=function(e,g){if(TeCmt.options.commentAjaxLoad){var f=$(TeCmt.options.commentAjaxLoadElement).children(".comment-list");if(0==f.length){$(TeCmt.options.commentAjaxLoadElement).html('<ol class="comment-list"></ol>');f=$(TeCmt.options.commentAjaxLoadElement).children(".comment-list")}}if(g!==undefined){var f=$("#comment-"+g);var i=f.find(".respond");if(f.find(".respond-children-wrapper").length<=0){var d='<ul class="respond-children-wrapper"><ol class="comment-list"></ol></ul>';if(i.length>0){i.before(d)}else{$(d).appendTo(f)}}f=$("#comment-"+g).find(".respond-children-wrapper")}var h=".respond-post-count span",c;$(h).length?(c=parseInt($(h).text().match(/\d+/)),$(h).html($(h).html().replace(c,c+1))):0;$(f).prepend(e)};$(document).on("submit","#comment-form",function(j){j.preventDefault();var i=$(this),g=i.attr("action"),f=i.serialize(),k=i.find("input[name=parent]").val(),l=i.find("input[name=_]").val(),d=new Date(),h=2000,c=d.getTime();if(typeof minTime=="undefined"){minTime=c+h}else{if(minTime&&c<minTime){TeCmt.dialog("你点的太快了","error");i.find("#submit").attr("disabled",true).addClass("loading").css("pointer-events","none");return false}else{minTime=c+h}}setTimeout(function(){i.find("#submit").attr("disabled",false).removeClass("loading").css("pointer-events","auto")},h);if(i.find("#textarea").val().length<1){TeCmt.dialog("说点什么吧","error");return false}if((undefined===l||TeCmt.options.commentAjaxLoad)&&g.indexOf("?")<0){g+="?_="+window.token}if(TeCmt.options.commentAjaxLoad&&undefined!==l){i.find("input[name=_]").remove();f=i.serialize()}$.ajax({url:g,type:"POST",data:f,dataType:"json",beforeSend:function(){i.find("#submit").addClass("loading").html('<i class="icon icon-loading icon-pulse"></i> 提交中...')},complete:function(){i.find("#submit").removeClass("loading").html("提交评论")},success:function(e){if(e.status==1){i.find("textarea").val("");b(e.body,k)}if(e.msg!==undefined&&e.msg!=""){TeCmt.dialog(e.msg,e.status==1?"success":"error")}},error:function(e,m,o){var n=e.responseText,p="";if(n.length>0){msgArr=$($(n).find("div.container").end()[7]).text().trim().split("\n");p=msgArr[0]}const q=["必须填写用户名","必须填写电子邮箱地址"];if(q.indexOf(p)!=-1){p="发表评论前请先登录"}TeCmt.dialog(p,"error")}});return false})},LoadComment:function(){var e=$(TeCmt.options.commentAjaxLoadElement),f=e.data("cid"),c=e.data("num");if(0==e.length||undefined==f||0===c){return false}if(history.pushState){window.addEventListener("popstate",function(h){var g=(null!=h.state&&undefined!=h.state.page)?h.state.page:null;if(null!=g){TeCmt.commentPage(h.state.url,g,true)}})}var d=e.data("comment-page");var b=window.location.href;if(""===d){d=1;if(0<b.indexOf("#")){b=b.substr(0,b.indexOf("#"))}}TeCmt.commentPage(b,d)},commentPage:function(b,d,c){var f=$(TeCmt.options.commentAjaxLoadElement).data("page");if(""===d){return false}c=undefined===c?false:c;if(f!=d){if(!c){var e={page:d,url:b};history.pushState(e,"",b)}TeCmt.ajaxLoadComment(d);return true}else{return false}},ajaxLoadComment:function(d){var c=$(TeCmt.options.commentAjaxLoadElement),e=c.data("cid");c.data("page",d);c.html('<div style="margin:100px auto;text-align:center;"><i class="icon icon-loading icon-large icon-pulse" title="加载中"></i></div>');var b=Date.parse(new Date());$.get(TeCmt.options.action+"/TeComment?comment="+e+"&commentPage="+d+"&_="+window.token+"&t="+b,function(f){var g="error";if(f.status==1){$("body").find("#tecmt-token").remove();$(f.token).appendTo($("body"));c.html(f.comments+f.pageNav);c.find(".page-navigator a").click(function(){var h=$(this).attr("href");if(history.pushState){var i=h.match(/comment-page-(\d*)#comments/);var j=null!=i?parseInt(i[1]):"";TeCmt.commentPage(h,j);$("html, body").animate({scrollTop:($("#comments").offset().top-60)},200);return false}else{return true}})}else{c.html("");TeCmt.dialog(f.msg,"error")}})},parseCmd:function(){if(TeCmt.cmd==null||TeCmt.cmd===undefined){return false}switch(TeCmt.cmd){case"smilies":TeCmt.getTool().find(".smiliesbox").slideToggle(150);break;case"img":TeCmt.insestImg();break}},insestImg:function(){var b=prompt("请输入图片地址","http://");if(b){TeCmt.write('<img src="'+b+'" rel="external nofollow" id="comments-img" alt="评论贴图" />',"")}},write:function(b,g){if(b===undefined){return false}var c=TeCmt.getText()[0];if(document.selection){c.focus();sel=document.selection.createRange();g?sel.text=b+sel.text+g:sel.text=b;c.focus()}else{if(c.selectionStart||c.selectionStart=="0"){var j=c.selectionStart;var i=c.selectionEnd;var h=i;g?c.value=c.value.substring(0,j)+b+c.value.substring(j,i)+g+c.value.substring(i,c.value.length):c.value=c.value.substring(0,j)+b+c.value.substring(i,c.value.length);g?h+=b.length+g.length:h+=b.length-i+j;if(j==i&&g){h-=g.length}c.focus();c.selectionStart=h;c.selectionEnd=h}else{c.value+=b+g;c.focus()}}},dialog:function(c,b){b=undefined==b?"success":b;if("undefined"==typeof jApp){if("error"==b){notice.alert(c)}}else{notice.alert(c)}},windowScroll:function(){if(TeCmt.options.commentAjaxLoad&&$(TeCmt.options.commentAjaxLoadElement).length>0){TeCmt.commentLoading=true;TeCmt.LoadComment();$("img.lazy").lazyload()}}}})(window);
